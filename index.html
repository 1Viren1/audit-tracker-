
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Environmental Audit Tracker (Firebase Enhanced)</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDj33uT80Gz2PYDwh-J9NaGsenEAwQon04",
      authDomain: "environmental-audit-tracker.firebaseapp.com",
      projectId: "environmental-audit-tracker",
      storageBucket: "environmental-audit-tracker.appspot.com",
      messagingSenderId: "865145801207",
      appId: "1:865145801207:web:a7300ccd1a81c5e44646f2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("auditForm");
    const savedContainer = document.getElementById("savedFormsContainer");

    window.saveForm = async function () {
      const beneficiary = document.getElementById("beneficiary").value;
      const address = document.getElementById("address").value;
      const visitDate = document.getElementById("visitDate").value;
      const visitBy = document.getElementById("visitBy").value;
      const photoInput = document.getElementById("photoUpload");
      const rows = document.querySelectorAll("#observationTable tr");

      const data = [];
      rows.forEach(row => {
        const cells = row.querySelectorAll("textarea");
        data.push({
          observation: cells[0].value,
          action: cells[1].value,
          timeline: cells[2].value
        });
      });

      const timestamp = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });

      const photoURLs = [];
      for (let file of photoInput.files) {
        const storageRef = ref(storage, 'audit_photos/' + Date.now() + '_' + file.name);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        photoURLs.push(url);
      }

      await addDoc(collection(db, "auditForms"), {
        timestamp,
        beneficiary,
        address,
        visitDate,
        visitBy,
        observations: data,
        photos: photoURLs
      });

      alert("Form and photos saved successfully!");
      form.reset();
      document.getElementById("observationTable").innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        document.getElementById("observationTable").innerHTML += `
          <tr>
            <td>${i}</td>
            <td><textarea></textarea></td>
            <td><textarea></textarea></td>
            <td><textarea></textarea></td>
          </tr>`;
      }

      loadSavedEntries(); // Reload entries after saving
    };

    async function loadSavedEntries() {
      savedContainer.innerHTML = ""; // Clear existing
      const q = query(collection(db, "auditForms"), orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.classList.add("form-block");

        let photosHTML = "";
        if (data.photos && data.photos.length > 0) {
          photosHTML = `<div class="saved-photos"><h4>Uploaded Photos:</h4>`;
          data.photos.forEach(url => {
            photosHTML += `<img src="${url}" alt="Uploaded Photo">`;
          });
          photosHTML += `</div>`;
        }

        div.innerHTML = `
          <h3>Saved Entry</h3>
          <p><strong>Timestamp (IST):</strong> ${data.timestamp}</p>
          <p><strong>Beneficiary:</strong> ${data.beneficiary}</p>
          <p><strong>Address:</strong> ${data.address}</p>
          <p><strong>Visit Date:</strong> ${data.visitDate}</p>
          <p><strong>Visited By:</strong> ${data.visitBy}</p>
          <table>
            <thead>
              <tr>
                <th>Sr. No.</th>
                <th>Observations</th>
                <th>Corrective Actions</th>
                <th>Timeline</th>
              </tr>
            </thead>
            <tbody>
              ${data.observations.map((item, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td>${item.observation}</td>
                  <td>${item.action}</td>
                  <td>${item.timeline}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
          ${photosHTML}
        `;
        savedContainer.appendChild(div);
      });
    }

    loadSavedEntries(); // Load entries on page load
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    h2, h3 { text-align: center; }
    form, .form-block {
      max-width: 1000px; margin: 30px auto; background: #fff;
      padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input[type="text"], input[type="file"], textarea {
      width: 100%; padding: 8px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 10px; vertical-align: top; }
    textarea { height: 60px; resize: vertical; }
    button {
      margin-top: 20px; padding: 10px 20px; background: #007BFF;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .saved-photos img {
      max-width: 150px; margin: 10px; border: 1px solid #ccc; border-radius: 5px;
    }
  </style>
</head>
<body>

<h2>Environmental Audit Tracker (Cloud Enabled)</h2>

<form id="auditForm">
  <label>Beneficiary Name:</label>
  <input type="text" id="beneficiary">
  <label>Address:</label>
  <input type="text" id="address">
  <label>Date of Site Visit:</label>
  <input type="text" id="visitDate">
  <label>Visit Conducted By:</label>
  <input type="text" id="visitBy">

  <table>
    <thead>
      <tr><th>Sr. No.</th><th>Observations</th><th>Corrective Actions</th><th>Timeline</th></tr>
    </thead>
    <tbody id="observationTable"></tbody>
  </table>

  <label>Upload Site Photos (Max 5 Images):</label>
  <input type="file" id="photoUpload" multiple accept="image/*">

  <button type="button" onclick="saveForm()">Save</button>
</form>

<div class="saved-forms" id="savedFormsContainer"></div>

<script>
  window.onload = () => {
    const tbody = document.getElementById("observationTable");
    for (let i = 1; i <= 5; i++) {
      tbody.innerHTML += `
        <tr>
          <td>${i}</td>
          <td><textarea></textarea></td>
          <td><textarea></textarea></td>
          <td><textarea></textarea></td>
        </tr>`;
    }
  };
</script>

</body>
</html>
