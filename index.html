<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Environmental Audit Tracker (with Progress Bar)</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDj33uT80Gz2PYDwh-J9NaGsenEAwQon04",
      authDomain: "environmental-audit-tracker.firebaseapp.com",
      projectId: "environmental-audit-tracker",
      storageBucket: "environmental-audit-tracker.appspot.com",
      messagingSenderId: "865145801207",
      appId: "1:865145801207:web:a7300ccd1a81c5e44646f2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    window.saveForm = async function () {
      const beneficiary = document.getElementById("beneficiary").value;
      const address = document.getElementById("address").value;
      const visitDate = document.getElementById("visitDate").value;
      const visitBy = document.getElementById("visitBy").value;
      const photoInput = document.getElementById("photoUpload");
      const rows = document.querySelectorAll("#observationTable tr");

      const data = [];
      rows.forEach(row => {
        const cells = row.querySelectorAll("textarea");
        data.push({
          observation: cells[0].value,
          action: cells[1].value,
          timeline: cells[2].value
        });
      });

      const timestamp = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
      const photoURLs = [];

      const statusBox = document.getElementById("uploadStatus");
      const progressBar = document.getElementById("uploadProgress");

      for (let file of photoInput.files) {
        const storageRef = ref(storage, 'audit_photos/' + Date.now() + '_' + file.name);
        const uploadTask = uploadBytesResumable(storageRef, file);
        progressBar.style.display = "block";

        await new Promise((resolve, reject) => {
          uploadTask.on('state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progressBar.value = progress;
              statusBox.innerText = "Uploading: " + file.name + " (" + Math.round(progress) + "%)";
            },
            (error) => {
              reject(error);
            },
            async () => {
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              photoURLs.push(url);
              resolve();
            }
          );
        });
      }

      await addDoc(collection(db, "auditForms"), {
        timestamp,
        beneficiary,
        address,
        visitDate,
        visitBy,
        observations: data,
        photos: photoURLs
      });

      statusBox.innerText = "Form and images saved successfully!";
      progressBar.style.display = "none";
      document.getElementById("auditForm").reset();

      const tbody = document.getElementById("observationTable");
      tbody.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        tbody.innerHTML += `
          <tr>
            <td>${i}</td>
            <td><textarea></textarea></td>
            <td><textarea></textarea></td>
            <td><textarea></textarea></td>
          </tr>`;
      }
    };
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    h2 { text-align: center; }
    form { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input[type="text"], input[type="file"], textarea {
      width: 100%; padding: 8px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 10px; vertical-align: top; }
    textarea { height: 60px; resize: vertical; }
    button {
      margin-top: 20px; padding: 10px 20px; background: #007BFF;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #uploadStatus {
      margin-top: 10px;
      color: green;
      font-weight: bold;
    }
    #uploadProgress {
      width: 100%;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>

<h2>Environmental Audit Tracker</h2>

<form id="auditForm">
  <label>Beneficiary Name:</label>
  <input type="text" id="beneficiary">
  <label>Address:</label>
  <input type="text" id="address">
  <label>Date of Site Visit:</label>
  <input type="text" id="visitDate">
  <label>Visit Conducted By:</label>
  <input type="text" id="visitBy">

  <table>
    <thead>
      <tr><th>Sr. No.</th><th>Observations</th><th>Corrective Actions</th><th>Timeline</th></tr>
    </thead>
    <tbody id="observationTable"></tbody>
  </table>

  <label>Upload Site Photos (Max 5 Images):</label>
  <input type="file" id="photoUpload" multiple accept="image/*">
  <progress id="uploadProgress" value="0" max="100"></progress>
  <div id="uploadStatus"></div>

  <button type="button" onclick="saveForm()">Save</button>
</form>

<script>
  window.onload = () => {
    const tbody = document.getElementById("observationTable");
    for (let i = 1; i <= 5; i++) {
      tbody.innerHTML += `
        <tr>
          <td>${i}</td>
          <td><textarea></textarea></td>
          <td><textarea></textarea></td>
          <td><textarea></textarea></td>
        </tr>`;
    }
  };
</script>

</body>
</html>
